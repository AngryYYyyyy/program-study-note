# 底层支撑搭建

所有环境都会在Linux操作系统下去搭建，如果对Linux操作不套熟悉以及Docker也不太熟悉的话，先去掌握一下Linux的基本操作搞定，还有Docker以及Docker-Compose的应用能力搞定。

我这里采用的Linux是云服务器的形式，华为云的CentOS-7.6版本。

需要搭建的底层支持有MySQL，Nacos，Redis，rabbitMQ，Elasticsearch，Kibana，Jenkins

Linux的版本尽量和我统一，你的选择就两个 **7.6，7.8** 这两个版本的Linux，一定是CentOS的。

特别是用6.x和8.x的Centos的同学，一定更换一下版本！！！！

## 一、准备Docker&Docker-Compose

在确认Linux发行版本没有问题之后，再安装Docker以及Docker-Compose

### 1.1 Docker安装

* 下载Docker依赖的组件

```sh
yum -y install yum-utils device-mapper-persistent-data lvm2
```

* 设置下载Docker服务的镜像源，设置为阿里云

```sh
yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
```

* 安装Docker服务

```
yum -y install docker-ce
```

* 安装成功后，需要启动docker服务，并且设置docker是开机自启项

```shell
# 启动docker服务
systemctl start docker
# 设置开机自动启动docker
systemctl enable docker
```

* 测试安装结果

```shell
docker version
```

| 最终效果                                                                                                                             |
| ------------------------------------------------------------------------------------------------------------------------------------ |
| ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1666872524001/ec67c830fed14a359f483cdaf20292ca.png) |

### 1.2 Docker-Compose安装

* 下载Docker-Compose：https://github.com/docker/compose/releases/tag/v2.10.0
* 下载的是：![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1666872524001/bb725485c765408eb66d06b641d528ce.png)
* 下载完毕后，将脚本直接拖拽到Linux操作系统中（我的图形化界面是 **Moba-Xterm** 的软件）
  下载地址：https://mobaxterm.mobatek.net/download.html
* 先赋予docker-compose文件一个可执行的权限

  ```
  chmod a+x docker-compose-linux-x86_64
  ```
* 将拥有可执行权限的docker-compose文件移动到系统默认的环境变量的PATH目录中

  ```
  mv docker-compose-linux-x86_64 /usr/bin/docker-compose
  ```
* 测试一下功能

  ```
  docker-compose version
  ```

| 测试效果                                                                                                                             |
| ------------------------------------------------------------------------------------------------------------------------------------ |
| ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1666872524001/e309e3a631e64c17be56f6f0d92bed9e.png) |

## 二、准备MySQL

MySQL我这里选择的5.7.24的版本，和我统一

因为我这边是云服务器搭建，密码尽量复杂一点，不然容易被干

准备在/usr/local/docker目录下安装后续需要的全部软件

在/usr/local/docker下构建了mysql_docker的目录，在里面准备docker-compose.yml

```yml
version: '3.1'
services:
  mysql:
    image: mysql:5.7.24
    container_name: mysql
    ports:
      - 3306:3306
    environment:
      - MYSQL_ROOT_PASSWORD=ZhengJinWei123!
    volumes:
      - ./data/:/var/lib/mysql/
```

docker安装的MySQL默认root用户是允许远程连接的

```
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json <<-'EOF'
{
  "registry-mirrors": [
  "https://5si2n9r4.mirror.aliyuncs.com",
  "https://registry.docker-cn.com",
  "https://docker.mirrors.ustc.edu.cn",
  "https://docker.mirrors.ustc.edu.cn"
  ]
}
EOF
sudo systemctl daemon-reload
sudo systemctl restart docker
```

如果你无法正常连接，需要看两种情况：

* 虚拟机安装的Linux，记得将防火墙直接关闭
  ```
  systemctl stop firewalld
  systemctl disable firewalld
  ```
* 云服务的Linux，不需要关闭防火墙的，需要在安装组中对外开放3306端口![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1666872524001/8fdae4144228438bb81ef4302b47597b.png)

MySQL连接效果

| 测试效果                                                                                                                             |
| ------------------------------------------------------------------------------------------------------------------------------------ |
| ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1666872524001/5403fd99d68d431da88ba2b7b81c6eb3.png) |

导入之前准备好sql脚本……

| 库表信息                                                                                                                             |
| ------------------------------------------------------------------------------------------------------------------------------------ |
| ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1666872524001/ea50c4f400014b09813e081de9e42f8c.png) |

## 三、准备Nacos

Nacos默认的启动方式是集群模式，集群模式占用的内存比较大，默认2G左右，直接采用单机模式的即可standalone模式~~~

暂时Nacos持久化采用内嵌的数据库derby就足够了。

准备docker-compose.yml

```yml
version: '3.1'
services:
  nacos:
    image: nacos/nacos-server:v2.1.1
    container_name: nacos
    ports:
      - 8848:8848
    environment:
      - MODE=standalone
```

直接启动容器

```
docker-compose up -d
```

| 查看效果                                                                                                                             |
| ------------------------------------------------------------------------------------------------------------------------------------ |
| ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1666872524001/ad80f80718d343a69f01d695e5cad6e1.png) |
| ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1666872524001/2346c4dfa581488785dce4e74583787f.png) |

## 四、准备Redis

Redis一样单机版的就ok，Redis的6379端口，经常会被作为挖矿的入口，Redis一定要设置连接密码，并且不要太简单。

为了设置密码，需要先准备一个Redis的配置文件，设置好连接密码信息，redis.conf文件编写

```
requirepass ZhengJinWei123!
```

再准备docker-compose.yml文件

docker run -v beacon_redis/conf:/usr/local/etc/redis --name beacon_redis redis:5.0.10 redis-server /usr/local/etc/redis/redis.conf

```
version: '3.1'
services:
  redis:
    image: redis:5.0.9
    container_name: redis
    ports:
      - 6379:6379
    volumes:
      - ./data/:/data/-
    command: ["redis-server","redis.conf"]
```

直接启动容器

```
docker-compose up -d
```

查看效果

| 查看效果                                                                                                                             |
| ------------------------------------------------------------------------------------------------------------------------------------ |
| ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1666872524001/0a41e8f0654e464587d7f73f7721f5c0.png) |

## 五、准备RabbitMQ

RabbitMQ安装成本很低，只需要设置好图形化界面的密码即可

准备docker-compose.yml文件即可

```yml
version: '3.1'
services:
  rabbitmq:
    image: rabbitmq:3.8.3-management
    container_name: rabbitmq
    ports:
      - 5672:5672
      - 15672:15672
    environment:
      - RABBITMQ_DEFAULT_USER=root
      - RABBITMQ_DEFAULT_PASS=ZhengJinWei123!
```

启动容器

```
docker-compose up -d
```

查看效果

| 图形化界面                                                                                                                           |
| ------------------------------------------------------------------------------------------------------------------------------------ |
| ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1666872524001/f8fe5490dd1f482f991c485e0705a02e.png) |

## 六、准备Elasticsearch&Kibana

```shell
docker run -d  --name beacon_es -e "ES_JAVA_OPTS=-Xms512m -Xmx512m"  -e "discovery.type=single-node" -v es-data:/usr/share/elasticsearch/data -v es-plugins:/usr/share/elasticsearch/plugins --privileged --network elastic_network -p 9200:9200 -p 9300:9300 elasticsearch:7.6.2
```

```shell
docker run -d --name beacon_kibana -e ELASTICSEARCH_HOSTS=http://beacon_es:9200 --network=elastic_network -p 5601:5601  kibana:7.6.2

```

Elasticsearch和Kibana要一起安装，Kibana要依赖Elasticsearch

Elasticsearch默认也是集群的方式去搭建，而且占用的内存默认情况下特别大，设置一下Elasticsearch的占用内存大小

准备docker-compose.yml

```yml
version: '3.1'
services:
  elasticsearch:
    image: elasticsearch:7.6.2
    container_name: elasticsearch
    ports:
      - 9200:9200
    environment:
      - "cluster.name=elasticsearch"
      - "discovery.type=single-node"
      - "ES_JAVA_OPTS=-Xms256m -Xmx256m"
      - "ELASTIC_PASSWORD=ZhengJinWei123!"
      - "xpack.security.enabled=true"
    volumes:
      - ./plugins/:/usr/share/elasticsearch/plugins/
      - ./data/:/usr/share/elasticsearch/data/
  kibana:
    image: kibana:7.6.2
    container_name: kibana
    ports:
      - 5601:5601
    depends_on:
      - elasticsearch
    environment:
      - "elasticsearch.hosts=http://elasticsearch:9200"
      - "ELASTICSEARCH_USERNAME=elastic"
      - "ELASTICSEARCH_PASSWORD=ZhengJinWei123!"
```

启动容器

```
docker-compose up -d
```

查看效果

| 查看效果                                                                                                                             |
| ------------------------------------------------------------------------------------------------------------------------------------ |
| ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1666872524001/925980873da84365a168aa04ebfbe258.png) |
| ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1666872524001/de90acfa84ab4d7d849ae33c59cb8f18.png) |

## 七、准备Jenkins

Jenkins用于发布整个项目做测试时需要使用。

Jenkins的版本一定的要选择。Jenkins最新的长期支持版本，不支持JDK1.8，采用的是JDK11。

经过选择，采用 **jenkins/jenkins:2.350-jdk8**  这个版本

准备docker-compose.yml

```yml
version: '3.1'
services:
  jenkins:
    image: jenkins/jenkins:2.350-jdk8
    container_name: jenkins
    ports:
      - 8080:8080
      - 50000:50000
    volumes:
      - ./data/:/var/jenkins_home/
```

启动容器

```
docker-compose up -d
```

第一次启动后，会发现抛出一个permission的错误，在写入log日志到/var/jenkins_home/时，没有权限，因为宿主机的数据源不允许其他用户写入。给数据卷data复制w权限：

```
chmod a+w data
```

再次启动容器

```
docker-compose up -d
```

需要稍微等一会，看到Jenkins的首页

| 查看效果                                                                                                                             |
| ------------------------------------------------------------------------------------------------------------------------------------ |
| ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1666872524001/e6338247330b49318a1a578d449c0909.png) |

首页的密码需要从容器的日志中查看。

| 查看首页密码                                                                                                                         |
| ------------------------------------------------------------------------------------------------------------------------------------ |
| ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1666872524001/9fbf09c57b5c486187dd82d57e3bc254.png) |

输入密码后，继续，然后需要指定选择安装插件的方式

5cb95bdeb2654a248947751c9258d151

| 选择插件来安装                                                                                                                       |
| ------------------------------------------------------------------------------------------------------------------------------------ |
| ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1666872524001/e5a090699aea4baf9be41ceaad4d9046.png) |

额外选择一个Git Parameter的插件

| 额外选择Git Parameter                                                                                                                |
| ------------------------------------------------------------------------------------------------------------------------------------ |
| ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1666872524001/28b941077fb44761ba2b50abfbe05ffc.png) |

安装插件（听天由命）

| 开始安装（我的安装ok）                                                                                                               |
| ------------------------------------------------------------------------------------------------------------------------------------ |
| ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1666872524001/eeff44d243cb4ad2b6ca1af0163b0786.png) |

指定用户

| 指定后面登录的用户名和密码                                                                                                           |
| ------------------------------------------------------------------------------------------------------------------------------------ |
| ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1666872524001/4b6acfffe1124c4fb5fe6195823a2406.png) |

最终查看到Jenkins的首页

| 查看Jenkins首页                                                                                                                      |
| ------------------------------------------------------------------------------------------------------------------------------------ |
| ![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1666872524001/f5f1d4dfb5b34b33b41757db3e2516d4.png) |
|                                                                                                                                      |
